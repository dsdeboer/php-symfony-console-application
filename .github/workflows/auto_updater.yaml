name: Auto Update packages

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  autoupdater:
    name: "Update composer packages"
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          token: ${{ secrets.RECTOR_ACCESS_TOKEN }}

      - uses: shivammathur/setup-php@9e72090525849c5e82e596468b86eb55e9cc5401
        with:
          php-version-file: .php-version
          coverage: none
          tools: composer:v2

      - uses: ramsey/composer-install@57532f8be5bda426838819c5ee9afb8af389d51a
        with:
          working-directory: app

      # Automatically run composer upgrade
      - name: Upgrade dependencies
        id: composer-update
        run: composer update --no-ansi --no-interaction --no-scripts --no-install --no-audit --no-progress --ignore-platform-req=ext-*
        working-directory: app

      - uses: stefanzweifel/git-auto-commit-action@e348103e9026cc0eee72ae06630dbe30c8bf7a79
        with:
          create_branch: true
          branch: "chore/scheduled-composer-upgrade-${{ github.run_number }}"
          commit_message: '[ci] Automatic composer upgrade'
          commit_author: 'GitHub Action <actions@github.com>'
          commit_user_email: 'action@github.com'

      - uses: actions/cache@v4.2.0
        with:
          path: app/var/cache/rector
          key: ${{ runner.os }}-rector-${{ github.run_id }}
          restore-keys: ${{ runner.os }}-rector-

      - run: vendor/bin/rector --ansi
        working-directory: app

      - uses: stefanzweifel/git-auto-commit-action@e348103e9026cc0eee72ae06630dbe30c8bf7a79
        with:
          branch: "chore/scheduled-composer-upgrade-${{ github.run_number }}"
          commit_message: '[rector] Rector fixes'
          commit_author: 'GitHub Action <actions@github.com>'
          commit_user_email: 'action@github.com'

      - uses: actions/cache@v4.2.0
        with:
          path: app/var/cache/ecs
          key: ${{ runner.os }}-ecs-${{ github.run_id }}
          restore-keys: ${{ runner.os }}-ecs-

      - run: vendor/bin/ecs check --fix --output-format=checkstyle
        working-directory: app

      - uses: stefanzweifel/git-auto-commit-action@e348103e9026cc0eee72ae06630dbe30c8bf7a79
        with:
          branch: "chore/scheduled-composer-upgrade-${{ github.run_number }}"
          commit_message: '[ecs] Easy Coding Standard fixes'
          commit_author: 'GitHub Action <actions@github.com>'
          commit_user_email: 'action@github.com'

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@67ccf781d68cd99b580ae25a5c18a1cc84ffff1f
        with:
          token: ${{ secrets.RECTOR_ACCESS_TOKEN }}
          reviewers: 'duncan-charpand'
          title: "[chore] Automatic scheduled composer upgrade"
          body: "chore: Automatic composer upgrade"
          branch: "chore/scheduled-composer-upgrade-${{ github.run_number }}"
